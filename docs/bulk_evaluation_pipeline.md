# 一括評価パイプライン仕様書

## 1. 概要

このパイプラインは、`list.csv`などの銘柄リストファイルに基づき、多数の銘柄に対してモデルの学習と評価を自動的に実行します。目的は、現在の予測アルゴリズムがどの銘柄で有効に機能するかを網羅的に調査し、そのパフォーマンスを記録することです。

評価プロセスは一時的なもので、既存の学習済みモデルや監視銘柄のデータに影響を与えずに実行できるように設計されています。

## 2. 主な機能

- **網羅的な評価**: 指定されたCSVファイル内の全銘柄に対して、モデルの学習と評価を自動実行します。
- **再開機能（レジューム）**: 中断された場合でも、次に実行した際に未処理の銘柄から評価を自動的に再開します。
- **一時的なデータ管理**:
    - 評価に必要な株価データは実行時に動的に取得されます。
    - 既存のデータを保護するため、このパイプラインのために新規に取得したデータのみが、処理完了後に自動的に削除されます。
- **評価結果の永続化**: 各モデルの性能指標（AUC, F1スコアなど）は、専用の `performance_log` テーブルに記録され、後から分析できます。
- **テストモード**: ハイパーパラメータの探索範囲を狭めることで、パイプライン全体の動作を高速にテストできます。

## 3. 実行方法 (Makefile)

### 通常の評価実行（再開可能）

中断された時点から評価を再開します。通常はこちらを使用してください。

```bash
make evaluate-all
```

### 初期状態からの評価実行

過去の評価ログをすべてクリアし、全銘柄の評価を最初からやり直します。

```bash
make evaluate-all-fresh
```

## 4. 処理フロー

`make evaluate-all` を実行すると、`script/bulk_evaluate.py` が以下の順序で処理を実行します。

1.  **評価テーブル準備**: 評価に必要な `market_list` と `performance_log` テーブルがDBに存在するか確認し、なければ作成します。
2.  **銘柄リスト読込**: `--source-file`で指定されたCSV（デフォルト: `list.csv`）を読み込み、評価対象の銘柄を `market_list` テーブルにロードします。
3.  **【Fresh Runの場合】**: `--fresh` オプションが指定されている場合、`performance_log` テーブルをクリアします。
4.  **データ準備**:
    a. DBにデータが存在しない銘柄と、特徴量として使われる共通インデックス（日経平均など）のデータを `yfinance` から取得し、DBに格納します。
    b. マクロ経済指標をFREDから取得し、更新します。
5.  **評価ループ**:
    a. `performance_log` を参照し、完了済みの銘柄を除外します。
    b. 未処理の銘柄ごとにループ処理を開始します。
    c. モデル学習と評価を実行します。（この時、モデル自体はDBに保存されません）
    d. 評価結果（正解率、AUCなど）を `performance_log` テーブルに記録します。
    e. データが不足しているなど、評価が不可能な銘柄は `skipped` として記録されます。
6.  **クリーンアップ**:
    a. 全銘柄の評価が完了した後、ステップ4-aでこのパイプラインが一時的にDBに格納した株価データのみを削除します。
    b. もともとDBに存在していたデータは削除されず、安全に保護されます。

## 5. データベースの変更点

このパイプラインのために、以下の2つのテーブルが新たに追加されました。

#### a. `market_list` テーブル

評価対象となる銘柄のリストを一時的に格納します。

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `ticker` | `VARCHAR(20)` | 主キー。銘柄コード |
| `name` | `VARCHAR(255)` | 銘柄名 |
| `market_segment` | `VARCHAR(255)` | 市場区分 |
| `industry_...` | `...` | 業種や規模などの付随情報 |
| `load_date` | `DATE` | データがロードされた日付 |

#### b. `performance_log` テーブル

各銘柄・各方向のモデル評価結果を記録します。このテーブルが本パイプラインの主たる成果物となります。

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `log_id` | `SERIAL PRIMARY KEY` | ログのユニークID |
| `ticker` | `VARCHAR(20)` | 銘柄コード |
| `direction` | `VARCHAR(10)` | 予測方向 ('up' or 'down') |
| `model_version` | `INTEGER` | （将来用。現在は-1が記録される） |
| `evaluation_datetime` | `TIMESTAMP` | 評価実行日時 |
| `accuracy` | `FLOAT` | 正解率 |
| `precision_score` | `FLOAT` | 適合率 |
| `recall_score` | `FLOAT` | 再現率 |
| `f1_score` | `FLOAT` | F1スコア |
| `roc_auc` | `FLOAT` | ROC AUCスコア |
| `features` | `TEXT` | 学習に使用した特徴量リスト |
| `training_period_start`| `DATE` | 学習データの開始日 |
| `training_period_end` | `DATE` | 学習データの終了日 |
| `status` | `VARCHAR(20)` | 処理ステータス（'success', 'failed', 'skipped'） |
| `error_message` | `TEXT` | エラー時のメッセージ |
| `created_at` | `TIMESTAMP` | ログ作成日時 |

## 6. 既存コードへの変更点

既存の機能に影響を与えない範囲で、以下の軽微な修正が行われました。

-   **`script/train_model.py`**:
    -   コアとなる学習・評価関数が、結果を戻り値として返すようにリファクタリングされました。
    -   これにより、`bulk_evaluate.py` から部品として安全に再利用可能になっています。
    -   `make train` で直接実行した際の動作は従来と全く同じです。
-   **`script/update_stock_data.py`**:
    -   `--tickers` 引数を追加し、外部から任意の銘柄リストを指定してデータ更新できるようになりました。
    -   引数なしで実行した場合（`make update-data`）の動作は従来と同じです。
